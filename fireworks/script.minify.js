"use strict";console.clear();const IS_MOBILE=window.innerWidth<=640,IS_DESKTOP=window.innerWidth>800,IS_HEADER=IS_DESKTOP&&window.innerHeight<300,IS_HIGH_END_DEVICE=(()=>{let e=navigator.hardwareConcurrency;if(!e)return!1;let t=window.innerWidth<=1024?4:8;return e>=t})(),MAX_WIDTH=7680,MAX_HEIGHT=4320,GRAVITY=.9;let simSpeed=1.1;function getDefaultScaleFactor(){return IS_MOBILE?.9:IS_HEADER?.75:1}let stageW,stageH,quality=1,isLowQuality=!1,isNormalQuality=!0,isHighQuality=!1;const QUALITY_LOW=1,QUALITY_NORMAL=2,QUALITY_HIGH=3,SKY_LIGHT_NONE=0,SKY_LIGHT_DIM=1,SKY_LIGHT_NORMAL=2,COLOR={Red:"#ff4d4f",Green:"#14fc56",Blue:"#1e7fff",Purple:"#e60aff",Gold:"#ffbf36",White:"#ffffff",Red1:"#fff1f0",Red2:"#ffccc7",Red3:"#ffa39e",Red4:"#ff7875",Red5:"#ff4d4f",Red6:"#f5222d",Red7:"#cf1322",Red8:"#a8071a",Red9:"#820014",Red10:"#5c0011",Green3:"#b7eb8f",Green4:"#95de64",Green5:"#73d13d",Green6:"#52c41a",Green7:"#389e0d",Green8:"#237804",Green9:"#135200",Green10:"#092b00",Blue3:"#91caff",Blue4:"#69b1ff",Blue5:"#4096ff",Blue6:"#1677ff",Blue7:"#0958d9",Blue8:"#003eb3",Blue9:"#002c8c",Blue10:"#001d66",Gold3:"#ffe58f",Gold4:"#ffd666",Gold5:"#ffc53d",Gold6:"#faad14",Gold7:"#d48806",Gold8:"#ad6800",Gold9:"#874d00",Gold10:"#613400",Purple3:"#d3adf7",Purple4:"#b37feb",Purple5:"#9254de",Purple6:"#722ed1",Purple7:"#531dab",Purple8:"#391085",Purple9:"#22075e",Purple10:"#120338",Magenta3:"#ffadd2",Magenta4:"#ff85c0",Magenta5:"#f759ab",Magenta6:"#eb2f96",Magenta7:"#c41d7f",Magenta8:"#9e1068",Magenta9:"#780650",Magenta10:"#520339"},INVISIBLE="_INVISIBLE_",PI_2=2*Math.PI,PI_HALF=.5*Math.PI,trailsStage=new Stage("trails-canvas"),mainStage=new Stage("main-canvas"),stages=[trailsStage,mainStage];function fullscreenEnabled(){return fscreen.fullscreenEnabled}function isFullscreen(){return!!fscreen.fullscreenElement}function toggleFullscreen(){fullscreenEnabled()&&(isFullscreen()?fscreen.exitFullscreen():fscreen.requestFullscreen(document.documentElement))}fscreen.addEventListener("fullscreenchange",()=>{store.setState({fullscreen:isFullscreen()})});const store={_listeners:new Set,_dispatch(e){this._listeners.forEach(t=>t(this.state,e))},state:{paused:!0,soundEnabled:!1,menuOpen:!1,openHelpTopic:null,fullscreen:isFullscreen(),config:{quality:String(IS_HIGH_END_DEVICE?3:2),shell:"Random",size:IS_DESKTOP?"3":IS_HEADER?"1.2":"2",autoLaunch:!0,finale:!1,skyLighting:"2",hideControls:IS_HEADER,longExposure:!1,scaleFactor:getDefaultScaleFactor()}},setState(e){let t=this.state;this.state=Object.assign({},this.state,e),this._dispatch(t),this.persist()},subscribe(e){return this._listeners.add(e),()=>this._listeners.remove(e)},load(){let e=localStorage.getItem("cm_fireworks_data");if(e){let{schemaVersion:t,data:l}=JSON.parse(e),a=this.state.config;switch(t){case"1.1":a.quality=l.quality,a.size=l.size,a.skyLighting=l.skyLighting;break;case"1.2":a.quality=l.quality,a.size=l.size,a.skyLighting=l.skyLighting,a.scaleFactor=l.scaleFactor;break;default:throw Error("version switch should be exhaustive")}console.log(`Loaded config (schema version ${t})`)}else if("1"===localStorage.getItem("schemaVersion")){let o;try{let r=localStorage.getItem("configSize");o="string"==typeof r&&JSON.parse(r)}catch(s){console.log("Recovered from error parsing saved config:"),console.error(s);return}let i=parseInt(o,10);i>=0&&i<=4&&(this.state.config.size=String(i))}},persist(){let e=this.state.config;localStorage.setItem("cm_fireworks_data",JSON.stringify({schemaVersion:"1.2",data:{quality:e.quality,size:e.size,skyLighting:e.skyLighting,scaleFactor:e.scaleFactor}}))}};function togglePause(e){let t=store.state.paused,l;l="boolean"==typeof e?e:!t,t!==l&&store.setState({paused:l})}function toggleSound(e){"boolean"==typeof e?store.setState({soundEnabled:e}):store.setState({soundEnabled:!store.state.soundEnabled})}function toggleMenu(e){"boolean"==typeof e?store.setState({menuOpen:e}):store.setState({menuOpen:!store.state.menuOpen})}function updateConfig(e){e=e||getConfigFromDOM(),store.setState({config:Object.assign({},store.state.config,e)}),configDidUpdate()}function configDidUpdate(){store.state.config,isLowQuality=1===(quality=qualitySelector()),isNormalQuality=2===quality,isHighQuality=3===quality,0===skyLightingSelector()&&(appNodes.canvasContainer.style.backgroundColor="#000"),Spark.drawWidth=3===quality?.75:1}IS_HEADER||store.load();const isRunning=(e=store.state)=>!e.paused&&!e.menuOpen,soundEnabledSelector=(e=store.state)=>e.soundEnabled,canPlaySoundSelector=(e=store.state)=>isRunning(e)&&soundEnabledSelector(e),qualitySelector=()=>+store.state.config.quality,shellNameSelector=()=>store.state.config.shell,shellSizeSelector=()=>+store.state.config.size,finaleSelector=()=>store.state.config.finale,skyLightingSelector=()=>+store.state.config.skyLighting,scaleFactorSelector=()=>store.state.config.scaleFactor,helpContent={shellType:{header:"Shell Type",body:'The type of firework that will be launched. Select "Random" for a nice assortment!'},shellSize:{header:"Shell Size",body:"The size of the fireworks. Modeled after real firework shell sizes, larger shells have bigger bursts with more stars, and sometimes more complex effects. However, larger shells also require more processing power and may cause lag."},quality:{header:"Quality",body:"Overall graphics quality. If the animation is not running smoothly, try lowering the quality. High quality greatly increases the amount of sparks rendered and may cause lag."},skyLighting:{header:"Sky Lighting",body:'Illuminates the background as fireworks explode. If the background looks too bright on your screen, try setting it to "Dim" or "None".'},scaleFactor:{header:"Scale",body:"Allows scaling the size of all fireworks, essentially moving you closer or farther away. For larger shell sizes, it can be convenient to decrease the scale a bit, especially on phones or tablets."},autoLaunch:{header:"Auto Fire",body:"Launches sequences of fireworks automatically. Sit back and enjoy the show, or disable to have full control."},finaleMode:{header:"Finale Mode",body:'Launches intense bursts of fireworks. May cause lag. Requires "Auto Fire" to be enabled.'},hideControls:{header:"Hide Controls",body:"Hides the translucent controls along the top of the screen. Useful for screenshots, or just a more seamless experience. While hidden, you can still tap the top-right corner to re-open this menu."},fullscreen:{header:"Fullscreen",body:"Toggles fullscreen mode."},longExposure:{header:"Open Shutter",body:"Experimental effect that preserves long streaks of light, similar to leaving a camera shutter open."}},nodeKeyToHelpKey={shellTypeLabel:"shellType",shellSizeLabel:"shellSize",qualityLabel:"quality",skyLightingLabel:"skyLighting",scaleFactorLabel:"scaleFactor",autoLaunchLabel:"autoLaunch",finaleModeLabel:"finaleMode",hideControlsLabel:"hideControls",fullscreenLabel:"fullscreen",longExposureLabel:"longExposure"},appNodes={countDownContainer:".count-down",tipContainer:".tip",messageContainer:".message",stageContainer:".stage-container",canvasContainer:".canvas-container",controls:".controls",menu:".menu",menuInnerWrap:".menu__inner-wrap",pauseBtn:".pause-btn",pauseBtnSVG:".pause-btn use",soundBtn:".sound-btn",soundBtnSVG:".sound-btn use",shellType:".shell-type",shellTypeLabel:".shell-type-label",shellSize:".shell-size",shellSizeLabel:".shell-size-label",quality:".quality-ui",qualityLabel:".quality-ui-label",skyLighting:".sky-lighting",skyLightingLabel:".sky-lighting-label",scaleFactor:".scaleFactor",scaleFactorLabel:".scaleFactor-label",autoLaunch:".auto-launch",autoLaunchLabel:".auto-launch-label",finaleModeFormOption:".form-option--finale-mode",finaleMode:".finale-mode",finaleModeLabel:".finale-mode-label",hideControls:".hide-controls",hideControlsLabel:".hide-controls-label",fullscreenFormOption:".form-option--fullscreen",fullscreen:".fullscreen",fullscreenLabel:".fullscreen-label",longExposure:".long-exposure",longExposureLabel:".long-exposure-label",helpModal:".help-modal",helpModalOverlay:".help-modal__overlay",helpModalHeader:".help-modal__header",helpModalBody:".help-modal__body",helpModalCloseBtn:".help-modal__close-btn"};function renderApp(e){let t=`#icon-${e.paused?"play":"pause"}`,l=`#icon-sound-${soundEnabledSelector()?"on":"off"}`;if(appNodes.pauseBtnSVG.setAttribute("href",t),appNodes.pauseBtnSVG.setAttribute("xlink:href",t),appNodes.soundBtnSVG.setAttribute("href",l),appNodes.soundBtnSVG.setAttribute("xlink:href",l),appNodes.controls.classList.toggle("hide",e.menuOpen||e.config.hideControls),appNodes.canvasContainer.classList.toggle("blur",e.menuOpen),appNodes.menu.classList.toggle("hide",!e.menuOpen),appNodes.finaleModeFormOption.style.opacity=e.config.autoLaunch?1:.32,appNodes.quality.value=e.config.quality,appNodes.shellType.value=e.config.shell,appNodes.shellSize.value=e.config.size,appNodes.autoLaunch.checked=e.config.autoLaunch,appNodes.finaleMode.checked=e.config.finale,appNodes.skyLighting.value=e.config.skyLighting,appNodes.hideControls.checked=e.config.hideControls,appNodes.fullscreen.checked=e.fullscreen,appNodes.longExposure.checked=e.config.longExposure,appNodes.scaleFactor.value=e.config.scaleFactor.toFixed(2),appNodes.menuInnerWrap.style.opacity=e.openHelpTopic?.12:1,appNodes.helpModal.classList.toggle("active",!!e.openHelpTopic),e.openHelpTopic){let{header:a,body:o}=helpContent[e.openHelpTopic];appNodes.helpModalHeader.textContent=a,appNodes.helpModalBody.textContent=o}}function handleStateChange(e,t){let l=canPlaySoundSelector(e),a=canPlaySoundSelector(t);l!==a&&(l?soundManager.resumeAll():soundManager.pauseAll())}function getConfigFromDOM(){return{quality:appNodes.quality.value,shell:appNodes.shellType.value,size:appNodes.shellSize.value,autoLaunch:appNodes.autoLaunch.checked,finale:appNodes.finaleMode.checked,skyLighting:appNodes.skyLighting.value,longExposure:appNodes.longExposure.checked,hideControls:appNodes.hideControls.checked,scaleFactor:parseFloat(appNodes.scaleFactor.value)}}Object.keys(appNodes).forEach(e=>{appNodes[e]=document.querySelector(appNodes[e])}),fullscreenEnabled()||appNodes.fullscreenFormOption.classList.add("remove"),store.subscribe(renderApp),store.subscribe(handleStateChange);const updateConfigNoEvent=()=>updateConfig();appNodes.quality.addEventListener("input",updateConfigNoEvent),appNodes.shellType.addEventListener("input",updateConfigNoEvent),appNodes.shellSize.addEventListener("input",updateConfigNoEvent),appNodes.autoLaunch.addEventListener("click",()=>setTimeout(updateConfig,0)),appNodes.finaleMode.addEventListener("click",()=>setTimeout(updateConfig,0)),appNodes.skyLighting.addEventListener("input",updateConfigNoEvent),appNodes.longExposure.addEventListener("click",()=>setTimeout(updateConfig,0)),appNodes.hideControls.addEventListener("click",()=>setTimeout(updateConfig,0)),appNodes.fullscreen.addEventListener("click",()=>setTimeout(toggleFullscreen,0)),appNodes.scaleFactor.addEventListener("input",()=>{updateConfig(),handleResize()}),Object.keys(nodeKeyToHelpKey).forEach(e=>{let t=nodeKeyToHelpKey[e];appNodes[e].addEventListener("click",()=>{store.setState({openHelpTopic:t})})}),appNodes.helpModalCloseBtn.addEventListener("click",()=>{store.setState({openHelpTopic:null})}),appNodes.helpModalOverlay.addEventListener("click",()=>{store.setState({openHelpTopic:null})});const COLOR_NAMES=Object.keys(COLOR),COLOR_CODES=COLOR_NAMES.map(e=>COLOR[e]),COLOR_CODES_W_INVIS=[...COLOR_CODES,INVISIBLE],COLOR_CODE_INDEXES=COLOR_CODES_W_INVIS.reduce((e,t,l)=>(e[t]=l,e),{}),COLOR_TUPLES={};function randomColorSimple(){return COLOR_CODES[Math.random()*COLOR_CODES.length|0]}COLOR_CODES.forEach(e=>{COLOR_TUPLES[e]={r:parseInt(e.substr(1,2),16),g:parseInt(e.substr(3,2),16),b:parseInt(e.substr(5,2),16)}});let lastColor;function randomColor(e){let t=e&&e.notSame,l=e&&e.notColor,a=e&&e.limitWhite,o=randomColorSimple();if(a&&o===COLOR.White&&.6>Math.random()&&(o=randomColorSimple()),t)for(;o===lastColor;)o=randomColorSimple();else if(l)for(;o===l;)o=randomColorSimple();return lastColor=o,o}function whiteOrGold(){return .5>Math.random()?COLOR.Gold:COLOR.White}function makePistilColor(e){return e===COLOR.White||e===COLOR.Gold?randomColor({notColor:e}):whiteOrGold()}const crysanthemumShell=(e=1)=>{let t=.25>Math.random(),l=.72>Math.random(),a=l?randomColor({limitWhite:!0}):[randomColor(),randomColor({notSame:!0})],o=l&&.42>Math.random(),r=o&&makePistilColor(a),s=l&&(.2>Math.random()||a===COLOR.White)?r||randomColor({notColor:a,limitWhite:!0}):null,i=!o&&a!==COLOR.White&&.42>Math.random(),n=t?1.1:1.25;return isLowQuality&&(n*=.8),isHighQuality&&(n=1.2),{shellSize:e,spreadSize:300+100*e,starLife:900+200*e,starDensity:n,color:a,secondColor:s,glitter:t?"light":"",glitterColor:whiteOrGold(),pistil:o,pistilColor:r,streamers:i}},ghostShell=(e=1)=>{let t=crysanthemumShell(e);t.starLife*=1.5;let l=randomColor({notColor:COLOR.White});t.streamers=!0;let a=.42>Math.random();return a&&makePistilColor(l),t.color=INVISIBLE,t.secondColor=l,t.glitter="",t},strobeShell=(e=1)=>{let t=randomColor({limitWhite:!0});return{shellSize:e,spreadSize:280+92*e,starLife:1100+200*e,starLifeVariation:.4,starDensity:1.1,color:t,glitter:"light",glitterColor:COLOR.White,strobe:!0,strobeColor:.5>Math.random()?COLOR.White:null,pistil:.5>Math.random(),pistilColor:makePistilColor(t)}},palmShell=(e=1)=>{let t=randomColor(),l=.5>Math.random();return{shellSize:e,color:t,spreadSize:250+75*e,starDensity:l?.15:.4,starLife:1800+200*e,glitter:l?"thick":"heavy"}},ringShell=(e=1)=>{let t=randomColor(),l=.75>Math.random();return{shellSize:e,ring:!0,color:t,spreadSize:300+100*e,starLife:900+200*e,starCount:2.2*PI_2*(e+1),pistil:l,pistilColor:makePistilColor(t),glitter:l?"":"light",glitterColor:t===COLOR.Gold?COLOR.Gold:COLOR.White,streamers:.3>Math.random()}},crossetteShell=(e=1)=>{let t=randomColor({limitWhite:!0});return{shellSize:e,spreadSize:300+100*e,starLife:750+160*e,starLifeVariation:.4,starDensity:.85,color:t,crossette:!0,pistil:.5>Math.random(),pistilColor:makePistilColor(t)}},floralShell=(e=1)=>({shellSize:e,spreadSize:300+120*e,starDensity:.12,starLife:500+50*e,starLifeVariation:.5,color:.65>Math.random()?"random":.15>Math.random()?randomColor():[randomColor(),randomColor({notSame:!0})],floral:!0}),fallingLeavesShell=(e=1)=>({shellSize:e,color:INVISIBLE,spreadSize:300+120*e,starDensity:.12,starLife:500+50*e,starLifeVariation:.5,glitter:"medium",glitterColor:COLOR.Gold,fallingLeaves:!0}),willowShell=(e=1)=>({shellSize:e,spreadSize:300+100*e,starDensity:.6,starLife:3e3+300*e,glitter:"willow",glitterColor:COLOR.Gold,color:INVISIBLE}),crackleShell=(e=1)=>{let t=.75>Math.random()?COLOR.Gold:randomColor();return{shellSize:e,spreadSize:380+75*e,starDensity:isLowQuality?.65:1,starLife:600+100*e,starLifeVariation:.32,glitter:"light",glitterColor:COLOR.Gold,color:t,crackle:!0,pistil:.65>Math.random(),pistilColor:makePistilColor(t)}},horsetailShell=(e=1)=>{let t=randomColor();return{shellSize:e,horsetail:!0,color:t,spreadSize:250+38*e,starDensity:.9,starLife:2500+300*e,glitter:"medium",glitterColor:.5>Math.random()?whiteOrGold():t,strobe:t===COLOR.White}};function randomShellName(){return .3>Math.random()?"Crysanthemum":shellNames[Math.random()*(shellNames.length-1)+1|0]}function randomShell(e){return IS_HEADER?randomFastShell()(e):shellTypes[randomShellName()](e)}function shellFromConfig(e){return shellTypes[shellNameSelector()](e)}const fastShellBlacklist=["Falling Leaves","Floral","Willow"];function randomFastShell(){let e="Random"===shellNameSelector(),t=e?randomShellName():shellNameSelector();if(e)for(;fastShellBlacklist.includes(t);)t=randomShellName();return shellTypes[t]}const shellTypes={Random:randomShell,Crackle:crackleShell,Crossette:crossetteShell,Crysanthemum:crysanthemumShell,"Falling Leaves":fallingLeavesShell,Floral:floralShell,Ghost:ghostShell,"Horse Tail":horsetailShell,Palm:palmShell,Ring:ringShell,Strobe:strobeShell,Willow:willowShell},shellNames=Object.keys(shellTypes);function init(){function e(e,t){e.innerHTML=t.reduce((e,t)=>e+=`<option value="${t.value}">${t.label}</option>`,"")}document.querySelector(".loading-init").remove(),appNodes.stageContainer.classList.remove("remove"),appNodes.countDownContainer.classList.remove("remove"),appNodes.messageContainer.classList.remove("remove"),appNodes.tipContainer.classList.remove("remove");let t="";shellNames.forEach(e=>t+=`<option value="${e}">${e}</option>`),appNodes.shellType.innerHTML=t,t="",['3"','4"','6"','8"','12"','16"'].forEach((e,l)=>t+=`<option value="${l}">${e}</option>`),appNodes.shellSize.innerHTML=t,e(appNodes.quality,[{label:"Low",value:1},{label:"Normal",value:2},{label:"High",value:3}]),e(appNodes.skyLighting,[{label:"None",value:0},{label:"Dim",value:1},{label:"Normal",value:2}]),e(appNodes.scaleFactor,[.5,.62,.75,.9,1,1.5,2].map(e=>({value:e.toFixed(2),label:`${100*e}%`}))),togglePause(!1),renderApp(store.state),configDidUpdate()}function fitShellPositionInBoundsH(e){return .64*e+.18}function fitShellPositionInBoundsV(e){return .75*e}function getRandomShellPositionH(){return fitShellPositionInBoundsH(Math.random())}function getRandomShellPositionV(){return fitShellPositionInBoundsV(Math.random())}function getRandomShellSize(){let e=shellSizeSelector(),t=Math.min(2.5,e),l=Math.random()*t,a=0===t?Math.random():1-l/t,o=Math.random()*(1-.65*a)*.5;return{size:e-l,x:fitShellPositionInBoundsH(.5>Math.random()?.5-o:.5+o),height:fitShellPositionInBoundsV(a)}}function launchShellFromConfig(e){let t=new Shell(shellFromConfig(shellSizeSelector())),l=mainStage.width,a=mainStage.height;t.launch(e?e.x/l:getRandomShellPositionH(),e?1-e.y/a:getRandomShellPositionV())}function seqRandomShell(){let e=getRandomShellSize(),t=new Shell(shellFromConfig(e.size));t.launch(e.x,e.height);let l=t.starLife;return t.fallingLeaves&&(l=4600),900+600*Math.random()+l}function seqRandomFastShell(){let e=randomFastShell(),t=getRandomShellSize(),l=new Shell(e(t.size));return l.launch(t.x,t.height),900+600*Math.random()+l.starLife}function seqTwoRandom(){let e=getRandomShellSize(),t=getRandomShellSize(),l=new Shell(shellFromConfig(e.size)),a=new Shell(shellFromConfig(t.size)),o=.2*Math.random()-.1;l.launch(.3+(.2*Math.random()-.1),e.height),setTimeout(()=>{a.launch(.7+o,t.height)},100);let r=Math.max(l.starLife,a.starLife);return(l.fallingLeaves||a.fallingLeaves)&&(r=4600),900+600*Math.random()+r}function seqTriple(){let e=randomFastShell(),t=shellSizeSelector(),l=Math.max(0,t-1.25),a=new Shell(e(t));return a.launch(.5+(.08*Math.random()-.04),.7),setTimeout(()=>{let t=new Shell(e(l));t.launch(.2+(.08*Math.random()-.04),.1)},1e3+400*Math.random()),setTimeout(()=>{let t=new Shell(e(l));t.launch(.8+(.08*Math.random()-.04),.1)},1e3+400*Math.random()),4e3}function seqPyramid(){let e=IS_DESKTOP?7:4,t=shellSizeSelector(),l=Math.max(0,t-3),a=.78>Math.random()?crysanthemumShell:ringShell,o=randomShell;function r(e,r){let s="Random"===shellNameSelector(),i=s?r?o:a:shellTypes[shellNameSelector()],n=new Shell(i(r?t:l));n.launch(e,r?.75:.42*(e<=.5?e/.5:(1-e)/.5))}let s=0,i=0;for(;s<=e;){if(s===e)setTimeout(()=>{r(.5,!0)},i);else{let n=s/e*.5,d=30*Math.random()+30;setTimeout(()=>{r(n,!1)},i),setTimeout(()=>{r(1-n,!1)},i+d)}s++,i+=200}return 3400+250*e}function seqSmallBarrage(){seqSmallBarrage.lastCalled=Date.now();let e=IS_DESKTOP?11:5,t=IS_DESKTOP?3:1,l=Math.max(0,shellSizeSelector()-2),a=.78>Math.random()?crysanthemumShell:ringShell,o=randomFastShell();function r(e,t){let r="Random"===shellNameSelector(),s=r?t?o:a:shellTypes[shellNameSelector()],i=new Shell(s(l));i.launch(e,.75*((Math.cos(5*e*Math.PI+PI_HALF)+1)/2))}let s=0,i=0;for(;s<e;){if(0===s)r(.5,!1),s+=1;else{let n=(s+1)/e/2,d=30*Math.random()+30,c=s===t;setTimeout(()=>{r(.5+n,c)},i),setTimeout(()=>{r(.5-n,c)},i+d),s+=2}i+=200}return 3400+120*e}seqSmallBarrage.cooldown=15e3,seqSmallBarrage.lastCalled=Date.now();const sequences=[seqRandomShell,seqTwoRandom,seqTriple,seqPyramid,seqSmallBarrage];let isFirstSeq=!0;const finaleCount=32;let currentFinaleCount=0;function startSequence(){if(isFirstSeq){if(isFirstSeq=!1,IS_HEADER)return seqTwoRandom();{let e=new Shell(crysanthemumShell(shellSizeSelector()));return e.launch(.5,.5),2400}}if(finaleSelector())return(seqRandomFastShell(),currentFinaleCount<32)?(currentFinaleCount++,170):(currentFinaleCount=0,6e3);let t=Math.random();return t<.08&&Date.now()-seqSmallBarrage.lastCalled>seqSmallBarrage.cooldown?seqSmallBarrage():t<.1?seqPyramid():t<.6&&!IS_HEADER?seqRandomShell():t<.8?seqTwoRandom():t<1?seqTriple():void 0}let activePointerCount=0,isUpdatingSpeed=!1;function handlePointerStart(e){if(activePointerCount++,e.y<50){if(e.x<50){togglePause();return}if(e.x>mainStage.width/2-25&&e.x<mainStage.width/2+25){toggleSound();return}if(e.x>mainStage.width-50){toggleMenu();return}}isRunning()&&(updateSpeedFromEvent(e)?isUpdatingSpeed=!0:e.onCanvas&&launchShellFromConfig(e))}function handlePointerEnd(e){activePointerCount--,isUpdatingSpeed=!1}function handlePointerMove(e){isRunning()&&isUpdatingSpeed&&updateSpeedFromEvent(e)}function handleKeydown(e){80===e.keyCode?togglePause():79===e.keyCode?toggleMenu():27===e.keyCode&&toggleMenu(!1)}function handleResize(){let e=window.innerWidth,t=window.innerHeight,l=Math.min(e,7680),a=e<=420?t:Math.min(t,4320);appNodes.stageContainer.style.width=l+"px",appNodes.stageContainer.style.height=a+"px",stages.forEach(e=>e.resize(l,a));let o=scaleFactorSelector();stageW=l/o,stageH=a/o}mainStage.addEventListener("pointerstart",handlePointerStart),mainStage.addEventListener("pointerend",handlePointerEnd),mainStage.addEventListener("pointermove",handlePointerMove),window.addEventListener("keydown",handleKeydown),handleResize(),window.addEventListener("resize",handleResize);let currentFrame=0,speedBarOpacity=0,autoLaunchTime=0;function updateSpeedFromEvent(e){if(isUpdatingSpeed||e.y>=mainStage.height-44){let t=(e.x-16)/(mainStage.width-32);return simSpeed=Math.min(Math.max(t,0),1),speedBarOpacity=1,!0}return!1}function updateGlobals(e,t){currentFrame++,!isUpdatingSpeed&&(speedBarOpacity-=t/30)<0&&(speedBarOpacity=0),store.state.config.autoLaunch&&(autoLaunchTime-=e)<=0&&(autoLaunchTime=1.25*startSequence())}function update(e,t){if(!isRunning())return;let l=e*simSpeed,a=simSpeed*t;updateGlobals(l,t);let o=1-(1-Star.airDrag)*a,r=1-(1-Star.airDragHeavy)*a,s=1-(1-Spark.airDrag)*a,i=l/1e3*.9;COLOR_CODES_W_INVIS.forEach(e=>{let t=Star.active[e];for(let n=t.length-1;n>=0;n-=1){let d=t[n];if(d.updateFrame!==currentFrame){if(d.updateFrame=currentFrame,d.life-=l,d.life<=0)t.splice(n,1),Star.returnInstance(d);else{let c=Math.pow(d.life/d.fullLife,.5),u=1-c;if(d.prevX=d.x,d.prevY=d.y,d.x+=d.speedX*a,d.y+=d.speedY*a,d.heavy?(d.speedX*=r,d.speedY*=r):(d.speedX*=o,d.speedY*=o),d.speedY+=i,d.spinRadius&&(d.spinAngle+=d.spinSpeed*a,d.x+=Math.sin(d.spinAngle)*d.spinRadius*a,d.y+=Math.cos(d.spinAngle)*d.spinRadius*a),d.sparkFreq)for(d.sparkTimer-=l;d.sparkTimer<0;)d.sparkTimer+=.75*d.sparkFreq+d.sparkFreq*u*4,Spark.add(d.x,d.y,d.sparkColor,Math.random()*PI_2,Math.random()*d.sparkSpeed*c,.8*d.sparkLife+Math.random()*d.sparkLifeVariation*d.sparkLife);d.life<d.transitionTime&&(d.secondColor&&!d.colorChanged&&(d.colorChanged=!0,d.color=d.secondColor,t.splice(n,1),Star.active[d.secondColor].push(d),d.secondColor===INVISIBLE&&(d.sparkFreq=0)),d.strobe&&(d.visible=Math.floor(d.life/d.strobeFreq)%3==0))}}}let h=Spark.active[e];for(let p=h.length-1;p>=0;p-=1){let $=h[p];$.life-=l,$.life<=0?(h.splice(p,1),Spark.returnInstance($)):($.prevX=$.x,$.prevY=$.y,$.x+=$.speedX*a,$.y+=$.speedY*a,$.speedX*=s,$.speedY*=s,$.speedY+=i)}}),render(a)}function render(e){let{dpr:t}=mainStage,l=stageW,a=stageH,o=trailsStage.ctx,r=mainStage.ctx;0!==skyLightingSelector()&&colorSky(e);let s=scaleFactorSelector();for(o.scale(t*s,t*s),r.scale(t*s,t*s),o.globalCompositeOperation="source-over",o.fillStyle=`rgba(0, 0, 0, ${store.state.config.longExposure?.0025:.175*e})`,o.fillRect(0,0,l,a),r.clearRect(0,0,l,a);BurstFlash.active.length;){let i=BurstFlash.active.pop(),n=o.createRadialGradient(i.x,i.y,0,i.x,i.y,i.radius);n.addColorStop(.024,"rgba(255, 255, 255, 1)"),n.addColorStop(.125,"rgba(255, 160, 20, 0.2)"),n.addColorStop(.32,"rgba(255, 140, 20, 0.11)"),n.addColorStop(1,"rgba(255, 120, 20, 0)"),o.fillStyle=n,o.fillRect(i.x-i.radius,i.y-i.radius,2*i.radius,2*i.radius),BurstFlash.returnInstance(i)}o.globalCompositeOperation="lighten",o.lineWidth=Star.drawWidth,o.lineCap=isLowQuality?"square":"round",r.strokeStyle="#fff",r.lineWidth=1,r.beginPath(),COLOR_CODES.forEach(e=>{let t=Star.active[e];o.strokeStyle=e,o.beginPath(),t.forEach(e=>{e.visible&&(o.moveTo(e.x,e.y),o.lineTo(e.prevX,e.prevY),r.moveTo(e.x,e.y),r.lineTo(e.x-1.6*e.speedX,e.y-1.6*e.speedY))}),o.stroke()}),r.stroke(),o.lineWidth=Spark.drawWidth,o.lineCap="butt",COLOR_CODES.forEach(e=>{let t=Spark.active[e];o.strokeStyle=e,o.beginPath(),t.forEach(e=>{o.moveTo(e.x,e.y),o.lineTo(e.prevX,e.prevY)}),o.stroke()}),speedBarOpacity&&(r.globalAlpha=speedBarOpacity,r.fillStyle=COLOR.Blue,r.fillRect(0,a-6,l*simSpeed,6),r.globalAlpha=1),o.setTransform(1,0,0,1,0,0),r.setTransform(1,0,0,1,0,0)}const currentSkyColor={r:0,g:0,b:0},targetSkyColor={r:0,g:0,b:0};function colorSky(e){let t=15*skyLightingSelector(),l=0;targetSkyColor.r=0,targetSkyColor.g=0,targetSkyColor.b=0,COLOR_CODES.forEach(e=>{let t=COLOR_TUPLES[e],a=Star.active[e].length;l+=a,targetSkyColor.r+=t.r*a,targetSkyColor.g+=t.g*a,targetSkyColor.b+=t.b*a});let a=Math.pow(Math.min(1,l/500),.3),o=Math.max(1,targetSkyColor.r,targetSkyColor.g,targetSkyColor.b);targetSkyColor.r=targetSkyColor.r/o*t*a,targetSkyColor.g=targetSkyColor.g/o*t*a,targetSkyColor.b=targetSkyColor.b/o*t*a,currentSkyColor.r+=(targetSkyColor.r-currentSkyColor.r)/8*e,currentSkyColor.g+=(targetSkyColor.g-currentSkyColor.g)/8*e,currentSkyColor.b+=(targetSkyColor.b-currentSkyColor.b)/8*e,appNodes.canvasContainer.style.backgroundColor=`rgb(${0|currentSkyColor.r}, ${0|currentSkyColor.g}, ${0|currentSkyColor.b})`}function createParticleArc(e,t,l,a,o){let r=t/l,s=e+t-.5*r;if(s>e)for(let i=e;i<s;i+=r)o(i+Math.random()*r*a);else for(let n=e;n>s;n+=r)o(n+Math.random()*r*a)}function createBurst(e,t,l=0,a=PI_2){let o=2*(.5*Math.sqrt(e/Math.PI))*Math.PI,r=o/2;for(let s=0;s<=r;s++){let i=s/r*PI_HALF,n=Math.cos(i),d=o*n,c=d*(a/PI_2),u=PI_2/d,h=Math.random()*u+l,p=.33*u;for(let $=0;$<c;$++){let f=Math.random()*p;t(u*$+h+f,n)}}}function crossetteEffect(e){createParticleArc(Math.random()*PI_HALF,PI_2,4,.5,t=>{Star.add(e.x,e.y,e.color,t,.6*Math.random()+.75,600)})}function floralEffect(e){let t=12+6*quality;createBurst(t,(t,l)=>{Star.add(e.x,e.y,e.color,t,2.4*l,1e3+300*Math.random(),e.speedX,e.speedY)}),BurstFlash.add(e.x,e.y,46),soundManager.playSound("burstSmall")}function fallingLeavesEffect(e){createBurst(7,(t,l)=>{let a=Star.add(e.x,e.y,INVISIBLE,t,2.4*l,2400+600*Math.random(),e.speedX,e.speedY);a.sparkColor=COLOR.Gold,a.sparkFreq=144/quality,a.sparkSpeed=.28,a.sparkLife=750,a.sparkLifeVariation=3.2}),BurstFlash.add(e.x,e.y,46),soundManager.playSound("burstSmall")}function crackleEffect(e){let t=isHighQuality?32:16;createParticleArc(0,PI_2,t,1.8,t=>{Spark.add(e.x,e.y,COLOR.Gold,t,2.4*Math.pow(Math.random(),.45),300+200*Math.random())})}mainStage.addEventListener("ticker",update);class Shell{constructor(e){if(Object.assign(this,e),this.starLifeVariation=e.starLifeVariation||.125,this.color=e.color||randomColor(),this.glitterColor=e.glitterColor||this.color,!this.starCount){let t=e.starDensity||1,l=this.spreadSize/54;this.starCount=Math.max(6,l*l*t)}}launch(e,t){let l=stageW,a=stageH,o=a-.45*a,r=a,s=Math.pow(.04*(r-(o-t*(o-50))),.64),i=this.comet=Star.add(e*(l-120)+60,r,"string"==typeof this.color&&"random"!==this.color?this.color:COLOR.White,Math.PI,s*(this.horsetail?1.2:1),s*(this.horsetail?100:400));i.heavy=!0,i.spinRadius=MyMath.random(.32,.85),i.sparkFreq=32/quality,isHighQuality&&(i.sparkFreq=8),i.sparkLife=320,i.sparkLifeVariation=3,("willow"===this.glitter||this.fallingLeaves)&&(i.sparkFreq=20/quality,i.sparkSpeed=.5,i.sparkLife=500),this.color===INVISIBLE&&(i.sparkColor=COLOR.Gold),Math.random()>.4&&!this.horsetail&&(i.secondColor=INVISIBLE,i.transitionTime=700*Math.pow(Math.random(),1.5)+500),i.onDeath=e=>this.burst(e.x,e.y),soundManager.playSound("lift")}burst(e,t){let l=this.spreadSize/96,a,o,r,s,i,n=.25,d=!1;this.crossette&&(o=e=>{d||(soundManager.playSound("crackleSmall"),d=!0),crossetteEffect(e)}),this.crackle&&(o=e=>{d||(soundManager.playSound("crackle"),d=!0),crackleEffect(e)}),this.floral&&(o=floralEffect),this.fallingLeaves&&(o=fallingLeavesEffect),"light"===this.glitter?(r=400,s=.3,i=300,n=2):"medium"===this.glitter?(r=200,s=.44,i=700,n=2):"heavy"===this.glitter?(r=80,s=.8,i=1400,n=2):"thick"===this.glitter?(r=16,s=isHighQuality?1.65:1.5,i=1400,n=3):"streamer"===this.glitter?(r=32,s=1.05,i=620,n=2):"willow"===this.glitter&&(r=120,s=.34,i=1400,n=3.8),r/=quality;let c=(d,c)=>{let u=this.spreadSize/1800,h=Star.add(e,t,a||randomColor(),d,c*l,this.starLife+Math.random()*this.starLife*this.starLifeVariation,this.horsetail?this.comet&&this.comet.speedX:0,this.horsetail?this.comet&&this.comet.speedY:-u);this.secondColor&&(h.transitionTime=this.starLife*(.05*Math.random()+.32),h.secondColor=this.secondColor),this.strobe&&(h.transitionTime=this.starLife*(.08*Math.random()+.46),h.strobe=!0,h.strobeFreq=20*Math.random()+40,this.strobeColor&&(h.secondColor=this.strobeColor)),h.onDeath=o,this.glitter&&(h.sparkFreq=r,h.sparkSpeed=s,h.sparkLife=i,h.sparkLifeVariation=n,h.sparkColor=this.glitterColor,h.sparkTimer=Math.random()*h.sparkFreq)};if("string"==typeof this.color){if(a="random"===this.color?null:this.color,this.ring){let u=Math.random()*Math.PI,h=.85*Math.pow(Math.random(),2)+.15;createParticleArc(0,PI_2,this.starCount,0,o=>{let d=Math.sin(o)*l*h,c=Math.cos(o)*l,p=MyMath.pointDist(0,0,d,c),$=MyMath.pointAngle(0,0,d,c)+u,f=Star.add(e,t,a,$,p,this.starLife+Math.random()*this.starLife*this.starLifeVariation);this.glitter&&(f.sparkFreq=r,f.sparkSpeed=s,f.sparkLife=i,f.sparkLifeVariation=n,f.sparkColor=this.glitterColor,f.sparkTimer=Math.random()*f.sparkFreq)})}else createBurst(this.starCount,c)}else if(Array.isArray(this.color)){if(.5>Math.random()){let p=Math.random()*Math.PI,$=Math.PI;a=this.color[0],createBurst(this.starCount,c,p,$),a=this.color[1],createBurst(this.starCount,c,p+Math.PI,$)}else a=this.color[0],createBurst(this.starCount/2,c),a=this.color[1],createBurst(this.starCount/2,c)}else throw Error("Invalid shell color. Expected string or array of strings, but got: "+this.color);if(this.pistil){let f=new Shell({spreadSize:.5*this.spreadSize,starLife:.6*this.starLife,starLifeVariation:this.starLifeVariation,starDensity:1.4,color:this.pistilColor,glitter:"light",glitterColor:this.pistilColor===COLOR.Gold?COLOR.Gold:COLOR.White});f.burst(e,t)}if(this.streamers){let g=new Shell({spreadSize:.9*this.spreadSize,starLife:.8*this.starLife,starLifeVariation:this.starLifeVariation,starCount:Math.floor(Math.max(6,this.spreadSize/45)),color:COLOR.White,glitter:"streamer"});g.burst(e,t)}if(BurstFlash.add(e,t,this.spreadSize/4),this.comet){let m=Math.min(2,shellSizeSelector()-this.shellSize);soundManager.playSound("burst",(1-m/2)*.3+.7)}}}const BurstFlash={active:[],_pool:[],_new:()=>({}),add(e,t,l){let a=this._pool.pop()||this._new();return a.x=e,a.y=t,a.radius=l,this.active.push(a),a},returnInstance(e){this._pool.push(e)}};function createParticleCollection(){let e={};return COLOR_CODES_W_INVIS.forEach(t=>{e[t]=[]}),e}const Star={drawWidth:3,airDrag:.98,airDragHeavy:.992,active:createParticleCollection(),_pool:[],_new:()=>({}),add(e,t,l,a,o,r,s,i){let n=this._pool.pop()||this._new();return n.visible=!0,n.heavy=!1,n.x=e,n.y=t,n.prevX=e,n.prevY=t,n.color=l,n.speedX=Math.sin(a)*o+(s||0),n.speedY=Math.cos(a)*o+(i||0),n.life=r,n.fullLife=r,n.spinAngle=Math.random()*PI_2,n.spinSpeed=.8,n.spinRadius=0,n.sparkFreq=0,n.sparkSpeed=1,n.sparkTimer=0,n.sparkColor=l,n.sparkLife=750,n.sparkLifeVariation=.25,n.strobe=!1,this.active[l].push(n),n},returnInstance(e){e.onDeath&&e.onDeath(e),e.onDeath=null,e.secondColor=null,e.transitionTime=0,e.colorChanged=!1,this._pool.push(e)}},Spark={drawWidth:0,airDrag:.9,active:createParticleCollection(),_pool:[],_new:()=>({}),add(e,t,l,a,o,r){let s=this._pool.pop()||this._new();return s.x=e,s.y=t,s.prevX=e,s.prevY=t,s.color=l,s.speedX=Math.sin(a)*o,s.speedY=Math.cos(a)*o,s.life=r,this.active[l].push(s),s},returnInstance(e){this._pool.push(e)}},soundManager={baseURL:"./lib/assets/",ctx:new(window.AudioContext||window.webkitAudioContext),sources:{lift:{volume:1,playbackRateMin:.85,playbackRateMax:.95,fileNames:["lift1.mp3","lift2.mp3","lift3.mp3"]},burst:{volume:1,playbackRateMin:.8,playbackRateMax:.9,fileNames:["burst1.mp3","burst2.mp3"]},burstSmall:{volume:.25,playbackRateMin:.8,playbackRateMax:1,fileNames:["burst-sm-1.mp3","burst-sm-2.mp3"]},crackle:{volume:.2,playbackRateMin:1,playbackRateMax:1,fileNames:["crackle1.mp3"]},crackleSmall:{volume:.3,playbackRateMin:1,playbackRateMax:1,fileNames:["crackle-sm-1.mp3"]}},preload(){let e=[];function t(e){if(e.status>=200&&e.status<300)return e;let t=Error(e.statusText);throw t.response=e,t}let l=Object.keys(this.sources);return l.forEach(l=>{let a=this.sources[l],{fileNames:o}=a,r=[];o.forEach(l=>{let a=this.baseURL+l,o=fetch(a).then(t).then(e=>e.arrayBuffer()).then(e=>new Promise(t=>{this.ctx.decodeAudioData(e,t)}));r.push(o),e.push(o)}),Promise.all(r).then(e=>{a.buffers=e})}),Promise.all(e)},pauseAll(){this.ctx.suspend()},resumeAll(){this.playSound("lift",0),setTimeout(()=>{this.ctx.resume()},250)},_lastSmallBurstTime:0,playSound(e,t=1){if(t=MyMath.clamp(t,0,1),!canPlaySoundSelector()||simSpeed<.95)return;if("burstSmall"===e){let l=Date.now();if(l-this._lastSmallBurstTime<20)return;this._lastSmallBurstTime=l}let a=this.sources[e];if(!a)throw Error(`Sound of type "${e}" doesn't exist.`);let o=a.volume,r=MyMath.random(a.playbackRateMin,a.playbackRateMax),s=o*t,i=r*(2-t),n=this.ctx.createGain();n.gain.value=s;let d=MyMath.randomChoice(a.buffers),c=this.ctx.createBufferSource();c.playbackRate.value=i,c.buffer=d,c.connect(n),n.connect(this.ctx.destination),c.start(0)}};function setLoadingStatus(e){document.querySelector(".loading-init__status").textContent=e}IS_HEADER?init():(setLoadingStatus("Lighting Fuses"),setTimeout(()=>{soundManager.preload().then(init,e=>(init(),Promise.reject(e)))},0));